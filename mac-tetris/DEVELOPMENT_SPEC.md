# Mac Tetris 開発仕様書

- 文書バージョン: 1.0
- 最終更新日: 2026-02-21
- 対象プロジェクト: `mac-tetris`

## 1. 目的

本仕様書は、macOS向けテトリス実装の機能要件・UI要件・技術要件を整理し、開発/保守/改善の基準を明確化することを目的とする。

## 2. 対象環境

- OS: macOS
- UIフレームワーク: SwiftUI
- 音声: AVFoundation
- ビルド: Swift Package Manager (`swift run`, `swiftc`)
- 配布形態: `.app` バンドル（ローカルインストール対応）

## 3. ゲーム仕様

### 3.1 基本ルール

- 10列のオーソドックスなテトリス
- 7-bag方式でテトリミノを生成
- 1ライン以上の同時消去に対応（スコア加算あり）
- レベル進行に応じて落下速度上昇
- ゴーストピース（着地予測）表示

### 3.2 ホールド仕様

- ホールドスロットは1つ
- 1ピースの落下中にホールドできる回数は1回
- ホールド時は現在ピースとホールドピースを交換（初回は格納のみ）
- ロック後に次ターンのホールド回数制限をリセット

### 3.3 NEXT仕様

- 次の3ピースを表示
- 積み上げ領域に半透過・縮小でオーバーレイ表示

## 4. 画面・レイアウト仕様

### 4.1 ウィンドウ

- デフォルトで画面上端にドッキング
- 左/右ドッキングを切替可能
- 縦サイズは固定（ユーザー変更不可）
- 横サイズは可変（ユーザー変更可）

### 4.2 プレイフィールド

- ブロックは常に最下段基準で積み上がる
- 幅変更時はセルサイズと行数を再計算し、表示領域を有効活用
- ブロックは上端から落下開始
- 落下開始位置・ゲームオーバー判定は現在の幅/行数に追従

### 4.3 HUD表示

- `S`(Score), `L`(Lines), `LV`(Level) を積み上げ領域の最上段に重ねて表示
- 余計なサイドパネル/別領域は持たない

## 5. 入力・操作仕様

### 5.1 設定メニュー（最小構成）

- `Settings > Controls`  
  - `WASD`
  - `Arrows`
- `Settings > Dock Left`
- `Settings > Dock Right`
- `Settings > Auto Pause When Inactive`

### 5.2 キーボード操作

- 共通:
  - `Space`: ハードドロップ
  - `C`: ホールド
  - `P`: 一時停止/再開
  - `R`: リスタート
- `WASD`モード:
  - `A` 左移動 / `D` 右移動 / `S` ソフトドロップ / `W` 右回転 / `Q` 左回転
- `Arrows`モード:
  - `←` 左移動 / `→` 右移動 / `↓` ソフトドロップ / `↑` 右回転 / `Z` 左回転

## 6. 描画仕様

- ブロックは単色フラットではなく、ハイライト/シャドウ付きの立体風表現
- 消去演出はフラッシュ・ビーム・スパークを組み合わせた派手なエフェクト
- 半透過要素（NEXT/HOLD/ゴースト）を使い、プレイ情報を重ね表示

## 7. 音響仕様

- BGMループ再生
- 効果音: 移動/回転/落下/ライン消去/ゲームオーバー/一時停止/再開/リスタート/ホールド
- 積み上がり高さとレベルに応じてBGMテンポを可変
- 非アクティブ時の自動一時停止に連動してゲーム進行を抑止

## 8. 安定性・状態管理

- リサイズ時に盤面行数を再計算し、ピース衝突時は安全側で再配置または再スポーン
- Observer/Key monitorの登録解除を明示し、ライフサイクルに追従
- ゲーム状態は `TetrisGame`（`@MainActor`）を中心に一元管理

## 9. 実装構成（主要ファイル）

- アプリ入口/メニュー: `Sources/mac-tetris/MacTetrisApp.swift`
- ゲームロジック: `Sources/mac-tetris/TetrisGame.swift`
- 画面描画/入力監視: `Sources/mac-tetris/TetrisView.swift`
- 音響制御: `Sources/mac-tetris/AudioManager.swift`
- 通知名定義: `Sources/mac-tetris/MenuActionNotifications.swift`
- 入力方式定義: `Sources/mac-tetris/ControlScheme.swift`

## 10. 既知の制約

- macOS 14以降で `onChange(of:perform:)` の非推奨警告が出る（挙動は現時点で問題なし）
- ネットワーク対戦・ランキング・保存リプレイ等は未実装

## 11. 受け入れ条件（抜粋）

- ホールドが1スロット/1回制限で正しく動作する
- メニューバーが最小設定項目のみである
- 幅変更時も落下・接地・ゲームオーバー判定が破綻しない
- 一番下の表示欠けが発生せず、表示行が完全に見える
- BGMと効果音が有効で、積み上がりに応じてテンポ変化する
